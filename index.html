<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Нур Аль-Ильм | Auto-Play Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #065f46; --primary-light: #10b981; --bg: #f8fafc;
            --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --nav-bg: rgba(255, 255, 255, 0.95); --border: rgba(226, 232, 240, 0.8);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --nav-bg: rgba(30, 41, 59, 0.95); --border: rgba(51, 65, 85, 0.5);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        header { 
            background: linear-gradient(135deg, var(--primary), #064e3b);
            color: white; padding: 50px 20px 25px; border-radius: 0 0 35px 35px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); flex-shrink: 0;
        }

        .container { flex: 1; overflow-y: auto; width: 100%; padding: 20px 20px 140px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 18px; 
            margin-bottom: 12px; border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; gap: 15px;
        }

        /* Вьювер */
        #viewer { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        .v-header { padding: 50px 20px 15px; background: var(--card-bg); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .v-body { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        
        /* Стили аята */
        .ayah-item { 
            margin-bottom: 30px; border-bottom: 1px solid var(--border); 
            padding-bottom: 20px; transition: 0.3s; padding: 15px; border-radius: 15px;
        }
        .ayah-item.playing { background: rgba(16, 185, 129, 0.05); border-left: 4px solid var(--primary-light); }
        .ar { font-family: 'Amiri', serif; font-size: 1.8rem; direction: rtl; text-align: right; color: var(--primary); line-height: 2.3; display: block; }
        .tr { color: var(--primary-light); font-style: italic; font-size: 14px; margin: 10px 0; }
        .ru { font-size: 15px; opacity: 0.8; line-height: 1.6; }

        /* Контролы */
        .scroll-controls {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--nav-bg); backdrop-filter: blur(20px);
            padding: 10px 20px; border-radius: 40px; border: 1px solid var(--border);
            display: none; align-items: center; gap: 15px; z-index: 3000;
        }
        .scroll-controls.active { display: flex; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg); backdrop-filter: blur(20px); display: flex; padding: 12px 5px 30px; border-top: 1px solid var(--border); }
        .n-btn { flex: 1; text-align: center; color: var(--text-muted); font-size: 10px; cursor: pointer; }
        .n-btn i { font-size: 20px; display: block; margin-bottom: 4px; }
        .n-btn.active { color: var(--primary-light); }
    </style>
</head>
<body>

<header>
    <h2 id="page-title">Коран</h2>
    <div id="page-sub">Священное Писание</div>
</header>

<div id="viewer">
    <div class="v-header">
        <i class="fas fa-chevron-left" onclick="closeViewer()" style="font-size: 20px; cursor: pointer;"></i>
        <b id="v-title" style="flex:1">Загрузка...</b>
        <div id="global-stop" style="color: #ef4444; display: none;" onclick="stopAudio()">
            <i class="fas fa-pause-circle" style="font-size: 28px;"></i>
        </div>
    </div>
    <div id="v-body" class="v-body"></div>
</div>

<div id="scroll-panel" class="scroll-controls">
    <button onclick="toggleAutoScroll()" style="background:var(--primary); color:white; border:none; width:35px; height:35px; border-radius:50%;"><i id="scroll-icon" class="fas fa-play"></i></button>
    <input type="range" id="scroll-speed" min="0.3" max="3" step="0.1" value="1" style="accent-color: var(--primary-light);">
    <span style="font-size: 9px; font-weight: 800; opacity: 0.5;">SCROLL</span>
</div>

<div class="container">
    <div id="p-quran" class="page active"><div id="quran-list"></div></div>
    <div id="p-dua" class="page" style="text-align:center; padding-top:50px;">Раздел Дуа (Хиснуль Муслим)</div>
    <div id="p-tasbih" class="page" style="text-align:center; padding-top:50px;">Четки</div>
</div>

<nav>
    <div class="n-btn active" onclick="switchTab('p-quran', 'Коран', 'Писание', this)"><i class="fas fa-book-quran"></i>Коран</div>
    <div class="n-btn" onclick="openLastRead()"><i class="fas fa-history"></i>История</div>
    <div class="n-btn" onclick="switchTab('p-dua', 'Дуа', 'Азкары', this)"><i class="fas fa-hands-praying"></i>Дуа</div>
    <div class="n-btn" onclick="switchTab('p-tasbih', 'Тасбих', 'Зикр', this)"><i class="fas fa-fingerprint"></i>Тасбих</div>
</nav>

<script>
    const audio = new Audio();
    let isScrolling = false;
    let scrollReq = null;
    let currentAyahIndex = -1;

    // --- ЛОГИКА АВТОПЕРЕКЛЮЧЕНИЯ АУДИО ---
    audio.onended = () => {
        const nextAyah = document.querySelectorAll('.play-btn')[currentAyahIndex + 1];
        if (nextAyah) {
            nextAyah.click(); // Автоматически "нажимаем" на следующий аят
            // Плавно скроллим к новому аяту
            nextAyah.closest('.ayah-item').scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            stopAudio();
        }
    };

    function toggleAudio(url, index, btn) {
        const icon = btn.querySelector('i');
        const parent = btn.closest('.ayah-item');

        if (audio.src === url && !audio.paused) {
            audio.pause();
            icon.className = 'fas fa-play-circle';
            parent.classList.remove('playing');
            document.getElementById('global-stop').style.display = 'none';
        } else {
            // Сброс старых стилей
            document.querySelectorAll('.ayah-item').forEach(el => el.classList.remove('playing'));
            document.querySelectorAll('.play-btn i').forEach(i => i.className = 'fas fa-play-circle');

            audio.src = url;
            audio.play();
            currentAyahIndex = index;
            icon.className = 'fas fa-pause-circle';
            parent.classList.add('playing');
            document.getElementById('global-stop').style.display = 'block';
        }
    }

    function stopAudio() {
        audio.pause();
        document.querySelectorAll('.play-btn i').forEach(i => i.className = 'fas fa-play-circle');
        document.querySelectorAll('.ayah-item').forEach(el => el.classList.remove('playing'));
        document.getElementById('global-stop').style.display = 'none';
    }

    // --- КОРАН ---
    async function init() {
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        const list = document.getElementById('quran-list');
        data.data.forEach(s => {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => openSurah(s.number, s.englishName);
            div.innerHTML = `<div style="width:30px; font-weight:800; color:var(--primary-light)">${s.number}</div><div style="flex:1"><b>${s.englishName}</b><br><small>${s.name}</small></div><i class="fas fa-book-open" style="opacity:0.2"></i>`;
            list.appendChild(div);
        });
    }

    async function openSurah(id, name) {
        localStorage.setItem('lastId', id); localStorage.setItem('lastName', name);
        const body = document.getElementById('v-body');
        document.getElementById('v-title').innerText = name;
        document.getElementById('viewer').style.display = 'flex';
        document.getElementById('scroll-panel').classList.add('active');
        body.innerHTML = "<p style='text-align:center; padding:50px;'>Загрузка...</p>";

        try {
            const [ar, ru, tr, au] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ru.kuliev`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ru.transliteration`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`)
            ]);
            const dAr = await ar.json(), dRu = await ru.json(), dTr = await tr.json(), dAu = await au.json();
            
            body.innerHTML = "";
            dAr.data.ayahs.forEach((a, i) => {
                const url = dAu.data.ayahs[i].audio;
                const item = document.createElement('div');
                item.className = 'ayah-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-size:11px; font-weight:800; opacity:0.3">АЯТ ${i+1}</span>
                        <div class="play-btn" onclick="toggleAudio('${url}', ${i}, this)" style="cursor:pointer; color:var(--primary); font-size:28px;">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </div>
                    <span class="ar">${a.text}</span>
                    <div class="tr">${dTr.data.ayahs[i].text}</div>
                    <div class="ru">${dRu.data.ayahs[i].text}</div>
                `;
                body.appendChild(item);
            });
        } catch (e) { body.innerHTML = "Ошибка загрузки"; }
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
    function closeViewer() {
        document.getElementById('viewer').style.display = 'none';
        document.getElementById('scroll-panel').classList.remove('active');
        stopAudio();
    }

    function toggleAutoScroll() {
        isScrolling = !isScrolling;
        const icon = document.getElementById('scroll-icon');
        if (isScrolling) { icon.className = 'fas fa-pause'; step(); } 
        else { icon.className = 'fas fa-play'; cancelAnimationFrame(scrollReq); }
    }

    function step() {
        if (!isScrolling) return;
        const speed = parseFloat(document.getElementById('scroll-speed').value);
        document.getElementById('v-body').scrollTop += speed;
        scrollReq = requestAnimationFrame(step);
    }

    function switchTab(id, title, sub, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.n-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('page-title').innerText = title;
        document.getElementById('page-sub').innerText = sub;
    }

    function openLastRead() {
        const id = localStorage.getItem('lastId');
        if(id) openSurah(id, localStorage.getItem('lastName'));
        else alert("Нет истории");
    }

    init();
</script>
</body>
</html>
