<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Нур Аль-Ильм | Исламское приложение</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #065f46; --primary-light: #10b981; --bg: #f8fafc;
            --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --nav-bg: rgba(255, 255, 255, 0.95); --border: rgba(226, 232, 240, 0.8);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --nav-bg: rgba(30, 41, 59, 0.95); --border: rgba(51, 65, 85, 0.5);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        header { 
            background: linear-gradient(135deg, var(--primary), #064e3b);
            color: white; padding: 45px 20px 20px; border-radius: 0 0 30px 30px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); flex-shrink: 0;
        }

        .container { flex: 1; overflow-y: auto; max-width: 500px; margin: 0 auto; width: 100%; padding: 20px 20px 140px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); border-radius: 18px; padding: 15px; 
            margin-bottom: 12px; border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .card:active { transform: scale(0.98); }
        
        .icon-box { width: 40px; height: 40px; background: rgba(16, 185, 129, 0.1); color: var(--primary-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800; }

        /* Вьювер */
        #viewer { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        .v-header { padding: 45px 20px 15px; background: var(--card-bg); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .v-body { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        
        .dua-item { background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .ar { font-family: 'Amiri', serif; font-size: 1.7rem; direction: rtl; text-align: right; color: var(--primary); line-height: 2; display: block; }
        .tr { color: var(--primary-light); font-style: italic; font-size: 14px; margin: 10px 0; }

        /* Чат ИИ */
        #ai-chat-window { height: 50vh; overflow-y: auto; background: var(--card-bg); border-radius: 20px; padding: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; font-size: 14px; max-width: 85%; line-height: 1.4; }
        .msg.ai { background: var(--bg); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* Навигация */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg); backdrop-filter: blur(15px); display: flex; padding: 10px 5px 25px; border-top: 1px solid var(--border); z-index: 1000; }
        .n-btn { flex: 1; text-align: center; color: var(--text-muted); font-size: 9px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .n-btn i { font-size: 20px; display: block; margin-bottom: 4px; }
        .n-btn.active { color: var(--primary-light); }

        /* Тасбих стили */
        .tally-circle {
            width: 200px; height: 200px; border: 8px solid var(--primary-light); 
            border-radius: 50%; margin: 0 auto; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 60px; 
            font-weight: 800; cursor: pointer; transition: transform 0.1s;
            position: relative; background: var(--card-bg); box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .tally-circle:active { transform: scale(0.95); }
        .tally-limit { font-size: 14px; opacity: 0.4; font-weight: 400; margin-top: -5px; }
    </style>
</head>
<body>

<header>
    <h2 id="page-title">Коран</h2>
    <div id="page-sub">Священное Писание</div>
</header>

<div id="viewer">
    <div class="v-header">
        <i class="fas fa-arrow-left" onclick="closeViewer()" style="font-size: 20px; cursor: pointer;"></i>
        <b id="v-title">Загрузка...</b>
        <div id="global-stop" style="margin-left: auto; color: #ef4444; display: none;" onclick="stopAudio()">
            <i class="fas fa-stop-circle" style="font-size: 24px;"></i>
        </div>
    </div>
    <div id="v-body" class="v-body"></div>
</div>

<div class="container">
    <div id="p-quran" class="page active">
        <div id="quran-list">Загрузка списка сур...</div>
    </div>

    <div id="p-dua" class="page">
        <div class="card" onclick="renderDuaCategory('morning')">
            <div class="icon-box"><i class="fas fa-sun"></i></div>
            <div><b>Утренние азкары</b><br><small>После намаза Фаджр</small></div>
        </div>
        <div class="card" onclick="renderDuaCategory('evening')">
            <div class="icon-box"><i class="fas fa-moon"></i></div>
            <div><b>Вечерние азкары</b><br><small>После намаза Аср</small></div>
        </div>
        <div class="card" onclick="renderDuaCategory('home')">
            <div class="icon-box"><i class="fas fa-house-user"></i></div>
            <div><b>Дом и семья</b><br><small>Вход, выход, за детей</small></div>
        </div>
        <div class="card" onclick="renderDuaCategory('difficulties')">
            <div class="icon-box"><i class="fas fa-hand-holding-heart"></i></div>
            <div><b>В трудностях</b><br><small>Против печали и страха</small></div>
        </div>
    </div>

    <div id="p-tasbih" class="page">
        <div style="text-align:center; background:var(--card-bg); padding:40px 20px; border-radius:30px; border: 1px solid var(--border);">
            <div id="z-step" style="color: var(--primary-light); font-weight: 800; font-size: 11px; margin-bottom: 10px; text-transform: uppercase;">ЭТАП 1: ПРОСЛАВЛЕНИЕ</div>
            
            <div id="z-ar" style="font-family:'Amiri'; font-size: 2.2rem; color: var(--primary); margin-bottom: 10px; min-height: 65px;">سُبْحَانَ ٱللَّٰهِ</div>
            <div id="z-ru" style="color: var(--text-muted); margin-bottom: 25px; min-height: 20px;">Субханаллах</div>
            
            <div class="tally-circle" onclick="doTally()">
                <span id="tally-num">0</span>
                <span class="tally-limit" id="z-limit">/ 33</span>
            </div>
            
            <button onclick="resetTally()" style="margin-top: 30px; border: none; background: none; color: var(--text-muted); font-weight: 700; cursor: pointer; opacity: 0.6;">СБРОСИТЬ</button>
        </div>
    </div>

    <div id="p-ai" class="page">
        <div id="ai-chat-window">
            <div class="msg ai">Ассаляму алейкум! Спросите меня о религии.</div>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="ai-input" placeholder="Ваш вопрос..." style="flex:1; padding:15px; border-radius:15px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main); font-size: 16px;">
            <button onclick="askAI()" style="background:var(--primary); color:white; border:none; border-radius:15px; width:55px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<nav>
    <div class="n-btn active" onclick="switchTab('p-quran', 'Коран', 'Писание', this)"><i class="fas fa-book-quran"></i>Коран</div>
    <div class="n-btn" onclick="switchTab('p-dua', 'Дуа', 'Хиснуль-Муслим', this)"><i class="fas fa-hands-praying"></i>Дуа</div>
    <div class="n-btn" onclick="openLastRead()"><i class="fas fa-history"></i>Последнее</div>
    <div class="n-btn" onclick="switchTab('p-tasbih', 'Тасбих', 'Четки', this)"><i class="fas fa-fingerprint"></i>Тасбих</div>
    <div class="n-btn" onclick="switchTab('p-ai', 'AI Поиск', 'Ассистент', this)"><i class="fas fa-robot"></i>Чат</div>
</nav>

<script>
    const quranAudio = new Audio();
    let currentPlayBtn = null;

    // --- БАЗА ДУА ---
    const duaLib = {
        morning: [
            { ar: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ", tr: "Асбахна ва асбаха-ль-мульку ли-Ллях", ru: "Мы дожили до утра, и этим утром вся власть принадлежит Аллаху.", t: "Утренний азкар" },
            { ar: "اللَّهُمَّ بِمَا أَصْبَحَ بِي مِنْ نِعْمَةٍ", tr: "Аллахумма ма асбаха би мин ни‘матин", ru: "О Аллах, любые милости, оказанные мне этим утром...", t: "Благодарность" }
        ],
        evening: [
            { ar: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ", tr: "Амсайна ва амса-ль-мульку ли-Ллях", ru: "Мы дожили до вечера, и этим вечером вся власть принадлежит Аллаху.", t: "Вечерний азкар" }
        ],
        difficulties: [
            { ar: "حَسْبُنَا اللَّهُ وَنِعْمَ الْوَكِيلُ", tr: "Хасбуна-ллаху ва ни‘ма-ль-вакиль", ru: "Нам достаточно Аллаха, Он — прекрасный Покровитель.", t: "При страхе" },
            { ar: "لاَ إِلَهَ إِلاَّ أَنْتَ سُبْحَانَكَ إِنِّي كُنْتُ مِنَ الظَّالِمِينَ", tr: "Ля иляха илля анта, субханака, инни кунту мина-з-залимин", ru: "Нет божества, кроме Тебя, Пречист Ты! Поистине, я был одним из несправедливых.", t: "Дуа Юнуса (а.с)" }
        ],
        home: [
            { ar: "بِسْمِ اللَّهِ وَلَجْنَا، وَبِسْمِ اللَّهِ خَرَجْنَا", tr: "Бисми-ллях валяджна, ва бисми-ллях харадждна", ru: "С именем Аллаха мы вошли и с именем Аллаха вышли.", t: "Вход в дом" }
        ]
    };

    function renderDuaCategory(cat) {
        const body = document.getElementById('v-body');
        document.getElementById('v-title').innerText = "Достоверные Дуа";
        document.getElementById('viewer').style.display = 'flex';
        body.innerHTML = "";
        duaLib[cat].forEach(d => {
            body.innerHTML += `
                <div class="dua-item">
                    <small style="color:var(--primary-light)">${d.t}</small>
                    <span class="ar">${d.ar}</span>
                    <div class="tr">${d.tr}</div>
                    <div class="ru">${d.ru}</div>
                </div>`;
        });
    }

    // --- КОРАН И АУДИО ---
    function toggleAudio(url, btn) {
        const icon = btn.querySelector('i');
        if (quranAudio.src === url && !quranAudio.paused) {
            quranAudio.pause();
            icon.className = 'fas fa-play-circle';
            document.getElementById('global-stop').style.display = 'none';
        } else {
            if (currentPlayBtn) currentPlayBtn.querySelector('i').className = 'fas fa-play-circle';
            quranAudio.src = url;
            quranAudio.play();
            icon.className = 'fas fa-pause-circle';
            currentPlayBtn = btn;
            document.getElementById('global-stop').style.display = 'block';
        }
        quranAudio.onended = () => {
            icon.className = 'fas fa-play-circle';
            document.getElementById('global-stop').style.display = 'none';
        };
    }

    function stopAudio() {
        quranAudio.pause();
        if (currentPlayBtn) currentPlayBtn.querySelector('i').className = 'fas fa-play-circle';
        document.getElementById('global-stop').style.display = 'none';
    }

    async function initQuran() {
        try {
            const res = await fetch('https://api.alquran.cloud/v1/surah');
            const data = await res.json();
            const list = document.getElementById('quran-list');
            list.innerHTML = "";
            data.data.forEach(s => {
                const el = document.createElement('div'); el.className = 'card';
                el.onclick = () => openSurah(s.number, s.englishName);
                el.innerHTML = `<div class="icon-box">${s.number}</div><div style="flex:1"><b>${s.englishName}</b><br><small>${s.name}</small></div><i class="fas fa-book-open" style="color:var(--primary-light)"></i>`;
                list.appendChild(el);
            });
        } catch (e) { }
    }

    async function openSurah(id, name) {
        localStorage.setItem('lastSurahId', id);
        localStorage.setItem('lastSurahName', name);
        const body = document.getElementById('v-body');
        document.getElementById('v-title').innerText = name;
        document.getElementById('viewer').style.display = 'flex';
        body.innerHTML = "<p style='text-align:center; padding:40px;'>Загрузка Священных аятов...</p>";
        
        try {
            const [ar, ru, tr, au] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ru.kuliev`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ru.transliteration`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`)
            ]);
            const dAr = await ar.json(), dRu = await ru.json(), dTr = await tr.json(), dAu = await au.json();
            body.innerHTML = "";
            dAr.data.ayahs.forEach((a, i) => {
                const audioUrl = dAu.data.ayahs[i].audio;
                const div = document.createElement('div');
                div.style.cssText = "margin-bottom:30px; border-bottom:1px solid var(--border); padding-bottom:15px;";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:15px;">
                        <span class="ar">${a.text}</span>
                        <div onclick="toggleAudio('${audioUrl}', this)" style="cursor:pointer; color:var(--primary); font-size:26px;">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </div>
                    <div class="tr" style="text-align:left;">${dTr.data.ayahs[i].text}</div>
                    <div class="ru" style="text-align:left; opacity:0.9;">${dRu.data.ayahs[i].text}</div>
                `;
                body.appendChild(div);
            });
        } catch (e) { body.innerHTML = "Ошибка загрузки."; }
    }

    function openLastRead() {
        const id = localStorage.getItem('lastSurahId');
        if(id) openSurah(id, localStorage.getItem('lastSurahName'));
        else alert("Вы еще не читали Коран");
    }

    function closeViewer() {
        document.getElementById('viewer').style.display = 'none';
        stopAudio();
    }

    function switchTab(id, title, sub, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.n-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('page-title').innerText = title;
        document.getElementById('page-sub').innerText = sub;
    }

    // --- ЛОГИКА ТАСБИХА (УМНЫЙ СЧЕТЧИК) ---
    let tCount = 0;
    let tPhase = 0; 
    const tasbihData = [
        { ar: "سُبْحَانَ ٱللَّٰهِ", ru: "Субханаллах", limit: 33, step: "Этап 1: Прославление" },
        { ar: "ٱلْحَمْدُ لِلَّٰهِ", ru: "Альхамдулиллях", limit: 33, step: "Этап 2: Благодарность" },
        { ar: "ٱللَّٰهُ أَكْبَرُ", ru: "Аллаху Акбар", limit: 33, step: "Этап 3: Возвеличивание" },
        { ar: "لَا إِلٰهَ إِلَّا ٱللَّٰهُ", ru: "Ля иляха илляллах", limit: 1, step: "Завершение" }
    ];

    function doTally() {
        tCount++;
        const current = tasbihData[tPhase];

        if (tCount > current.limit) {
            if (tPhase < tasbihData.length - 1) {
                tPhase++; 
                tCount = 1; 
                if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
            } else {
                resetTally();
                return;
            }
        } else {
            if (navigator.vibrate) navigator.vibrate(40);
        }
        updateTasbihUI();
    }

    function updateTasbihUI() {
        const data = tasbihData[tPhase];
        document.getElementById('z-ar').innerText = data.ar;
        document.getElementById('z-ru').innerText = data.ru;
        document.getElementById('z-step').innerText = data.step;
        document.getElementById('tally-num').innerText = tCount;
        document.getElementById('z-limit').innerText = "/ " + data.limit;
    }

    function resetTally() {
        tCount = 0; tPhase = 0;
        updateTasbihUI();
        document.getElementById('tally-num').innerText = "0";
    }

    // --- ЧАТ ИИ ---
    function askAI() {
        const inp = document.getElementById('ai-input'), win = document.getElementById('ai-chat-window');
        if(!inp.value) return;
        win.innerHTML += `<div class="msg user">${inp.value}</div>`;
        const v = inp.value.toLowerCase(); inp.value = "";
        setTimeout(() => {
            let r = "Для получения точной фетвы обратитесь к местному имаму. Помните, что Аллах — Знающий.";
            if(v.includes("намаз")) r = "Намаз — это связь с Творцом. Не оставляйте его, это ваш свет в обоих мирах.";
            if(v.includes("дуа")) r = "Пророк (ﷺ) сказал: 'Дуа — это поклонение'. Просите искренне.";
            win.innerHTML += `<div class="msg ai"><b>Ассистент:</b><br>${r}</div>`;
            win.scrollTop = win.scrollHeight;
        }, 600);
    }

    initQuran();
</script>
</body>
</html>
