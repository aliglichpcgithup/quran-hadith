<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Нур Аль-Ильм | Все в одном</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #065f46; --primary-light: #10b981; --bg: #f8fafc;
            --card-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --nav-bg: rgba(255, 255, 255, 0.95); --border: rgba(226, 232, 240, 0.8);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --nav-bg: rgba(30, 41, 59, 0.95); --border: rgba(51, 65, 85, 0.5);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        header { 
            background: linear-gradient(135deg, var(--primary), #064e3b);
            color: white; padding: 50px 20px 25px; border-radius: 0 0 35px 35px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); flex-shrink: 0;
        }

        .container { flex: 1; overflow-y: auto; max-width: 500px; margin: 0 auto; width: 100%; padding: 20px 20px 100px; }

        /* Страницы */
        .page { display: none; animation: fadeIn 0.4s ease; height: 100%; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Карточки */
        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 16px; 
            margin-bottom: 12px; display: flex; align-items: center; 
            border: 1px solid var(--border); transition: 0.2s; cursor: pointer;
        }
        .num-box { 
            width: 40px; height: 40px; background: rgba(16, 185, 129, 0.1); 
            color: var(--primary-light); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; margin-right: 15px; 
        }

        /* Тасбих */
        .tasbih-ui { text-align: center; background: var(--card-bg); border-radius: 30px; padding: 30px 10px; border: 1px solid var(--border); }
        .tally-circle {
            width: 180px; height: 180px; border-radius: 50%; border: 8px solid var(--primary-light);
            margin: 20px auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.1s; background: none; color: inherit;
        }
        .tally-circle:active { transform: scale(0.95); background: rgba(16, 185, 129, 0.05); }

        /* Чат ИИ */
        #ai-chat-window { height: 50vh; overflow-y: auto; background: var(--card-bg); border-radius: 20px; padding: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; font-size: 14px; max-width: 85%; line-height: 1.5; }
        .msg.ai { background: var(--bg); align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--border); }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* Вьювер (Коран/Хадисы) */
        #viewer { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; }
        .v-header { padding: 45px 20px 15px; background: var(--card-bg); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .v-body { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .ar-txt { font-family: 'Amiri', serif; font-size: 1.7rem; direction: rtl; text-align: right; color: var(--primary); line-height: 2.2; display: block; }

        /* Поиск в хадисах */
        .h-search-box { position: sticky; top: -20px; background: var(--bg); padding: 10px 0; z-index: 10; margin-bottom: 15px; }
        .h-search-box input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); }

        /* Навигация */
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg); 
            backdrop-filter: blur(15px); display: flex; padding: 12px 5px 30px; border-top: 1px solid var(--border); z-index: 1000; 
        }
        .n-btn { flex: 1; text-align: center; color: var(--text-muted); font-size: 10px; font-weight: 700; cursor: pointer; }
        .n-btn i { font-size: 20px; display: block; margin-bottom: 4px; }
        .n-btn.active { color: var(--primary-light); }
    </style>
</head>
<body>

<header>
    <h2 id="page-title">Коран</h2>
    <div id="page-sub" style="font-size: 12px; opacity: 0.8;">Священное Писание</div>
</header>

<div id="viewer">
    <div class="v-header">
        <i class="fas fa-times" onclick="closeViewer()" style="font-size: 22px; cursor: pointer;"></i>
        <b id="v-title">Сура</b>
    </div>
    <div id="v-body" class="v-body"></div>
</div>

<div class="container">
    <div id="p-quran" class="page active">
        <div id="quran-list">Загрузка списка сур...</div>
    </div>

    <div id="p-hadith" class="page">
        <div class="card" onclick="loadFullHadiths('rus-bukhari', 'Сахих аль-Бухари')">
            <div class="num-box">Б</div>
            <div style="flex:1"><b>Сахих аль-Бухари</b><br><small>7563 хадиса</small></div>
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="card" onclick="loadFullHadiths('rus-muslim', 'Сахих Муслим')">
            <div class="num-box">М</div>
            <div style="flex:1"><b>Сахих Муслим</b><br><small>3033 хадиса</small></div>
            <i class="fas fa-chevron-right"></i>
        </div>
    </div>

    <div id="p-tasbih" class="page">
        <div class="tasbih-ui">
            <div id="z-ar" style="font-family:'Amiri'; font-size: 2.2rem; color: var(--primary);">سُبْحَانَ ٱللَّٰهِ</div>
            <div id="z-ru" style="color: var(--text-muted); margin-bottom: 10px;">Субханаллах</div>
            <button class="tally-circle" onclick="doTally()">
                <span id="tally-num" style="font-size: 50px; font-weight: 800;">0</span>
                <small>НАЖАТЬ</small>
            </button>
            <br>
            <button onclick="resetTally()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Сбросить</button>
        </div>
    </div>

    <div id="p-ai" class="page">
        <div id="ai-chat-window">
            <div class="msg ai">Ассаляму алейкум! Спросите меня о намазе, сабре, хадисах или Коране.</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <input type="text" id="ai-input" placeholder="Ваш вопрос..." style="flex:1; padding:15px; border-radius:15px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main);">
            <button onclick="askAI()" style="background:var(--primary); color:white; border:none; border-radius:15px; width:55px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<nav>
    <div class="n-btn active" onclick="switchTab('p-quran', 'Коран', 'Священное Писание', this)"><i class="fas fa-book-quran"></i>Коран</div>
    <div class="n-btn" onclick="switchTab('p-hadith', 'Хадисы', 'Сборники Пророка (ﷺ)', this)"><i class="fas fa-mosque"></i>Хадисы</div>
    <div class="n-btn" onclick="switchTab('p-tasbih', 'Тасбих', 'Цифровые четки', this)"><i class="fas fa-fingerprint"></i>Тасбих</div>
    <div class="n-btn" onclick="switchTab('p-ai', 'AI Поиск', 'Умный ассистент', this)"><i class="fas fa-robot"></i>ИИ</div>
</nav>

<script>
    const quranAudio = new Audio();
    let allHadiths = [];
    let hadithVisibleCount = 40;

    // --- 1. ЛОГИКА КОРАНА ---
    async function initQuran() {
        try {
            const res = await fetch('https://api.alquran.cloud/v1/surah');
            const data = await res.json();
            const list = document.getElementById('quran-list');
            list.innerHTML = "";
            data.data.forEach(s => {
                const el = document.createElement('div');
                el.className = 'card';
                el.onclick = () => openSurah(s.number, s.englishName);
                el.innerHTML = `<div class="num-box">${s.number}</div><div style="flex:1"><b>${s.englishName}</b><br><small>${s.name}</small></div><i class="fas fa-play-circle" style="color:var(--primary-light)"></i>`;
                list.appendChild(el);
            });
        } catch (e) { document.getElementById('quran-list').innerText = "Ошибка загрузки Корана."; }
    }

    async function openSurah(id, name) {
        const body = document.getElementById('v-body');
        document.getElementById('v-title').innerText = name;
        document.getElementById('viewer').style.display = 'flex';
        body.innerHTML = "<div style='text-align:center; padding:50px;'>Загрузка аятов и аудио...</div>";

        try {
            const [ar, ru, au] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ru.kuliev`),
                fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`)
            ]);
            const dAr = await ar.json(); const dRu = await ru.json(); const dAu = await au.json();

            body.innerHTML = "";
            dAr.data.ayahs.forEach((a, i) => {
                const audioUrl = dAu.data.ayahs[i].audio;
                const div = document.createElement('div');
                div.id = `ayah-box-${i}`;
                div.style.cssText = "margin-bottom:30px; border-bottom:1px solid var(--border); padding-bottom:15px; scroll-margin-top:100px;";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                        <span class="ar-txt" style="flex:1;">${a.text}</span>
                        <button class="q-play-btn" data-index="${i}" data-url="${audioUrl}" onclick="toggleAudio(this)" 
                                style="background:rgba(16,185,129,0.1); border:none; border-radius:10px; padding:10px; color:var(--primary); cursor:pointer;">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div style="font-size:14px; margin-top:10px; opacity:0.8;"><b>${i+1}.</b> ${dRu.data.ayahs[i].text}</div>
                `;
                body.appendChild(div);
            });
        } catch (e) { body.innerHTML = "Ошибка загрузки данных суры."; }
    }

    function toggleAudio(btn) {
        const url = btn.getAttribute('data-url');
        const icon = btn.querySelector('i');

        if (quranAudio.src === url && !quranAudio.paused) {
            quranAudio.pause();
            resetAudioIcons();
            return;
        }

        resetAudioIcons();
        icon.className = 'fas fa-spinner fa-spin';
        quranAudio.src = url;
        quranAudio.play();

        quranAudio.onplaying = () => {
            icon.className = 'fas fa-pause';
            btn.closest('[id^="ayah-box"]').scrollIntoView({ behavior: 'smooth' });
        };

        quranAudio.onended = () => {
            const nextIdx = parseInt(btn.getAttribute('data-index')) + 1;
            const nextBtn = document.querySelector(`.q-play-btn[data-index="${nextIdx}"]`);
            if (nextBtn) toggleAudio(nextBtn);
            else resetAudioIcons();
        };
    }

    function resetAudioIcons() {
        document.querySelectorAll('.q-play-btn i').forEach(i => i.className = 'fas fa-play');
    }

    // --- 2. ЛОГИКА ХАДИСОВ ---
    async function loadFullHadiths(slug, name) {
        const body = document.getElementById('v-body');
        document.getElementById('v-title').innerText = name;
        document.getElementById('viewer').style.display = 'flex';
        body.innerHTML = "<div style='text-align:center; padding:50px;'>Загрузка всей базы хадисов...</div>";

        try {
            const res = await fetch(`https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/${slug}.json`);
            const data = await res.json();
            allHadiths = data.hadiths;
            hadithVisibleCount = 40;

            body.innerHTML = `
                <div class="h-search-box">
                    <input type="text" id="h-search-in" placeholder="Поиск по словам (напр: намаз)..." oninput="searchHadiths(this.value)">
                </div>
                <div id="h-list-container"></div>
                <div id="h-load-more" style="text-align:center; padding:20px; opacity:0.5;">Листайте для загрузки...</div>
            `;

            renderHadithBatch();

            body.onscroll = () => {
                if (body.scrollTop + body.clientHeight >= body.scrollHeight - 300) {
                    renderHadithBatch();
                }
            };
        } catch (e) { body.innerHTML = "Ошибка загрузки хадисов."; }
    }

    function renderHadithBatch() {
        const container = document.getElementById('h-list-container');
        const batch = allHadiths.slice(hadithVisibleCount - 40, hadithVisibleCount);
        batch.forEach(h => {
            const div = document.createElement('div');
            div.className = 'card'; div.style.display = 'block';
            div.innerHTML = `<small style="color:var(--primary-light)">№${h.hadithnumber}</small><p style="margin-top:8px; font-size:14px; line-height:1.6;">${h.text}</p>`;
            container.appendChild(div);
        });
        hadithVisibleCount += 40;
    }

    function searchHadiths(val) {
        const query = val.toLowerCase();
        const container = document.getElementById('h-list-container');
        const trigger = document.getElementById('h-load-more');
        container.innerHTML = "";
        
        if (!query) {
            hadithVisibleCount = 40; trigger.style.display = "block";
            renderHadithBatch(); return;
        }

        trigger.style.display = "none";
        const filtered = allHadiths.filter(h => h.text.toLowerCase().includes(query)).slice(0, 50);
        filtered.forEach(h => {
            const div = document.createElement('div');
            div.className = 'card'; div.style.display = 'block';
            div.innerHTML = `<small style="color:var(--primary-light)">№${h.hadithnumber}</small><p>${h.text}</p>`;
            container.appendChild(div);
        });
    }

    // --- 3. ТАСБИХ ---
    let tCount = 0, zIdx = 0;
    const zikrs = [
        {ar: "سُبْحَانَ ٱللَّٰهِ", ru: "Субханаллах"},
        {ar: "ٱلْحَمْدُ لِلَّٰهِ", ru: "Альхамдулиллях"},
        {ar: "ٱللَّٰهُ أَكْبَرُ", ru: "Аллаху Акбар"}
    ];

    function doTally() {
        tCount++;
        if (tCount > 33) {
            tCount = 1;
            zIdx = (zIdx + 1) % 3;
            document.getElementById('z-ar').innerText = zikrs[zIdx].ar;
            document.getElementById('z-ru').innerText = zikrs[zIdx].ru;
        }
        document.getElementById('tally-num').innerText = tCount;
        if (navigator.vibrate) navigator.vibrate(40);
    }
    function resetTally() {
        tCount = 0; zIdx = 0;
        document.getElementById('tally-num').innerText = "0";
        document.getElementById('z-ar').innerText = zikrs[0].ar;
        document.getElementById('z-ru').innerText = zikrs[0].ru;
    }

    // --- 4. AI ПОМОЩНИК ---
    const knowledge = {
        "намаз": "Намаз — это столп веры. Пророк (ﷺ) сказал: 'Первое, за что будет спрошен раб в Судный день — это его намаз'.",
        "сабр": "Сабр (терпение) упоминается в Коране более 90 раз. 'Воистину, Аллах с терпеливыми' (2:153).",
        "родители": "Рай находится под ногами ваших матерей. Благочестие к родителям — одна из любимейших дел Аллаха.",
        "намерение": "Все дела принимаются только по намерениям. Очищайте свой ният перед любым делом."
    };

    function askAI() {
        const inp = document.getElementById('ai-input');
        const win = document.getElementById('ai-chat-window');
        const val = inp.value.trim().toLowerCase();
        if (!val) return;

        win.innerHTML += `<div class="msg user">${inp.value}</div>`;
        inp.value = "";
        
        setTimeout(() => {
            let res = "Я изучаю ваш вопрос. Попробуйте спросить про: намаз, сабр, родителей или намерения.";
            for (let k in knowledge) { if (val.includes(k)) res = knowledge[k]; }
            win.innerHTML += `<div class="msg ai"><b>Ассистент:</b><br>${res}</div>`;
            win.scrollTop = win.scrollHeight;
        }, 600);
    }

    // --- ОБЩИЕ ФУНКЦИИ ---
    function switchTab(id, title, sub, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.n-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('page-title').innerText = title;
        document.getElementById('page-sub').innerText = sub;
    }

    function closeViewer() {
        document.getElementById('viewer').style.display = 'none';
        quranAudio.pause();
    }

    initQuran();
</script>
</body>
</html>